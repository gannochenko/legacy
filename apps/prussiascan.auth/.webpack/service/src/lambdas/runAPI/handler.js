(()=>{"use strict";var e={368:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InvitationTokenEntity=void 0,t.InvitationTokenEntity=class{}},960:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(368),t)},58:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),t.UserRoleEnum=void 0,(o=t.UserRoleEnum||(t.UserRoleEnum={})).admin="admin",o.contributor="contributor",o.cicd="cicd"},422:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(58),t)},896:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(960),t),n(o(422),t)},198:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.RolesGuard=void 0;const i=o(481),a=o(143),s=o(896);let c=class{constructor(e){this.reflector=e}canActivate(e){const t=this.reflector.get("roles",e.getHandler());if(!t)return!0;const o=e.switchToHttp().getRequest().user;return!(!o||!o.roles)&&(!!o.roles.includes(s.UserRoleEnum.admin)||((e,t)=>e.filter((e=>t.includes(e))).length>0)(t,o.roles))}};c=r([(0,i.Injectable)(),n("design:paramtypes",[a.Reflector])],c),t.RolesGuard=c},179:function(e,t,o){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.bootstrapServer=void 0;const n=o(143),i=o(481),a=(r(o(806)),o(315)),s=o(672),c=o(188),l=r(o(860)),u=o(431),d=["multipart/form-data","image/png","image/jpg"];let p;t.bootstrapServer=async()=>{if(!p){const e=(0,l.default)(),t=await n.NestFactory.create(u.ApplicationModule,new c.ExpressAdapter(e));t.setGlobalPrefix("auth"),t.useGlobalPipes(new i.ValidationPipe({transform:!0,whitelist:!0})),t.use((0,s.eventContext)()),await t.init(),p=(0,a.createServer)(e,void 0,d)}return p}},925:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.APIKeyAuthenticationMiddleware=void 0;const r=o(896);t.APIKeyAuthenticationMiddleware=class{use(e,t,o){var n;const i=e.headers["x-api-key"]||"";let a=[];i===process.env.CONTRIBUTOR_API_KEY&&(a=[r.UserRoleEnum.contributor]),i===process.env.CICD_API_KEY&&(a=[r.UserRoleEnum.cicd]),"hmu8hsdgodgiugdsh"===i&&(a=[r.UserRoleEnum.admin]),a.length&&(e.user={...null!==(n=e.user)&&void 0!==n?n:{},roles:a}),o()}}},431:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationModule=void 0;const n=o(481),i=o(143),a=o(198),s=o(885),c=o(501),l=o(925);let u=class{configure(e){e.apply(l.APIKeyAuthenticationMiddleware).forRoutes({path:"*",method:n.RequestMethod.POST})}};u=r([(0,n.Module)({imports:[s.InvitationModule,c.OptionsModule],providers:[{provide:i.APP_GUARD,useClass:a.RolesGuard}]})],u),t.ApplicationModule=u},926:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.InvitationController=void 0;const a=o(481),s=o(952),c=o(763),l=o(475),u=o(896);let d=class{constructor(e){this.service=e}async invite(e){return this.service.invite(e)}async join(e){return this.service.join(e)}};r([(0,a.Post)("invite"),(0,l.Roles)(u.UserRoleEnum.admin),i(0,(0,a.Body)()),n("design:type",Function),n("design:paramtypes",[c.InviteDto]),n("design:returntype",Promise)],d.prototype,"invite",null),r([(0,a.Post)("join"),i(0,(0,a.Body)()),n("design:type",Function),n("design:paramtypes",[c.JoinDto]),n("design:returntype",Promise)],d.prototype,"join",null),d=r([(0,a.Controller)(),n("design:paramtypes",[s.InvitationService])],d),t.InvitationController=d},763:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.JoinDto=t.InviteDto=void 0;const i=o(849);class a{}r([(0,i.IsEmail)(),n("design:type",String)],a.prototype,"email",void 0),r([(0,i.IsString)(),(0,i.IsOptional)(),n("design:type",String)],a.prototype,"role",void 0),t.InviteDto=a;class s{}r([(0,i.IsString)(),(0,i.MinLength)(1,{message:"Token is too short"}),n("design:type",String)],s.prototype,"token",void 0),r([(0,i.IsEmail)(),n("design:type",String)],s.prototype,"email",void 0),t.JoinDto=s},551:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(926),t)},512:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.InvitationModule=void 0;const n=o(481),i=o(551),a=o(952),s=o(915),c=o(501),l=o(64);let u=class{};u=r([(0,n.Module)({imports:[c.OptionsModule,l.JwtModule.register({secret:"really-secret-secret"})],controllers:[i.InvitationController],providers:[a.InvitationService,s.UserService],exports:[a.InvitationService]})],u),t.InvitationModule=u},952:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.InvitationService=void 0;const i=o(481),a=o(336),s=o(113),c=o(837),l=o(608),u=o(64),d=o(34),p=o(136),f=o(442),v=o(206),y=o(915),h=new a.DynamoDB.DocumentClient({...d.awsOptions,apiVersion:"2012-08-10"}),m=null!=="prussiascan.auth_InvitationTokens"?"prussiascan.auth_InvitationTokens":"",_=(0,c.promisify)(s.randomBytes),b=(0,l.compile)(f.invitationMessageTemplate);let g=class{constructor(e,t){this.userService=e,this.jwtService=t}async invite(e){const{email:t,role:o}=e,r=await this.getInvitation(t);if(null==r?void 0:r.Item)throw new i.HttpException("User already invited",409);const n=(await _(48)).toString("hex"),a={email:t,token:n,role:null!=o?o:"",createdAt:(new Date).toISOString()};return await(0,p.tryExecute)((async()=>await h.put({TableName:m,Item:a}).promise()),"Could not create an invitation"),await this.sendInvitationMessage(t,n),{data:a}}async join(e){const{token:t,email:o}=e,r=await this.getInvitation(o);if(!(null==r?void 0:r.Item))throw new i.HttpException("You were not invited",400);const{token:n,role:a}=null==r?void 0:r.Item;let s="";const c=await this.userService.getByEmail(o);if(c){if(n!==t)throw new i.HttpException("Token is not right",403);s=c.id}else{const{data:e}=await this.userService.create({email:o,roles:a?[a]:[]});s=e.id}return{data:{token:await this.jwtService.signAsync({userId:s},{expiresIn:"7 days",audience:`https://${process.env.DOMAIN}`})}}}async getInvitation(e){return await(0,p.tryExecute)((async()=>await h.get({TableName:m,Key:{email:e}}).promise()),"Could not get the invitation")}async sendInvitationMessage(e,t){return(0,v.sendMessage)(e,'New message from "Архитектурный Архив"',b({invitationLink:`https://prussiascans.gannochenko.app/join?token=${encodeURIComponent(t)}&email=${encodeURIComponent(e)}`}))}};g=r([(0,i.Injectable)(),n("design:paramtypes",[y.UserService,u.JwtService])],g),t.InvitationService=g},915:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.UserService=void 0;const i=o(481),a=o(336),s=o(828),c=o(34),l=o(136),u=new a.DynamoDB.DocumentClient({...c.awsOptions,apiVersion:"2012-08-10"}),d=null!=="prussiascan.auth_Users"?"prussiascan.auth_Users":"";let p=class{constructor(){}async create(e){const{email:t,roles:o}=e,r={id:(0,s.v4)(),email:t,roles:o,createdAt:(new Date).toISOString()};return await(0,l.tryExecute)((async()=>await u.put({TableName:d,Item:r}).promise()),"Could not create an user"),{data:r}}async getByEmail(e){var t;const o=await(0,l.tryExecute)((async()=>await u.query({TableName:d,IndexName:"emailIndex",ProjectionExpression:"id, email",KeyConditionExpression:"#email = :email",ExpressionAttributeNames:{"#email":"email"},ExpressionAttributeValues:{":email":e},Limit:1}).promise()),"Could not get a user by email");return null===(t=null==o?void 0:o.Items)||void 0===t?void 0:t[0]}async isEmailTaken(e){const t=await(0,l.tryExecute)((async()=>await u.get({TableName:d,Key:{email:e}}).promise()),"Could not check the email existence");return!!(null==t?void 0:t.Item)}};p=r([(0,i.Injectable)(),n("design:paramtypes",[])],p),t.UserService=p},885:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(512),t)},442:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.invitationMessageTemplate=void 0,t.invitationMessageTemplate="\nhtml\n    body\n        h1 Приглашаем вас стать редактором контента на сайте Архитектурный архив!\n        h2 Ссылка для авторизации на сайте:\n        p(style='white-space:pre-wrap') #{invitationLink}\n        p Всего хорошего!\n        p С уважением, команда сайта Архитектурный архив.\n"},206:function(e,t,o){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sendMessage=void 0;const n=r(o(167));t.sendMessage=(e,t,o)=>n.default.post("https://api.sendinblue.com/v3/smtp/email",{sender:{name:"Администратор сайта Архитектурный архив",email:"noreply@prussiascan.ru"},to:[{email:e}],subject:t,htmlContent:o},{headers:{"Content-Type":"application/json",Accept:"application/json","api-key":"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"}})},934:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsModule=void 0;const n=o(481),i=o(159);let a=class{};a=r([(0,n.Module)({providers:[i.OptionsService],exports:[i.OptionsService]})],a),t.OptionsModule=a},159:function(e,t,o){var r=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(t,o,a):n(t,o))||a);return i>3&&a&&Object.defineProperty(t,o,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsService=void 0;const n=o(481),i=o(336),a=o(34),s=new i.DynamoDB.DocumentClient({...a.awsOptions,apiVersion:"2012-08-10"}),c=null!=="prussiascan.auth_Flags"?"prussiascan.auth_Flags":"";let l=class{async set(e,t){const o={code:e,value:t};try{await s.put({TableName:c,Item:o,ReturnConsumedCapacity:"TOTAL"}).promise()}catch(e){throw console.error(e),new n.InternalServerErrorException("Could not set a value")}return{data:o.value,aux:{}}}async get(e){var t,o;try{const r=await s.get({TableName:c,Key:{code:e}}).promise();return null!==(o=null===(t=null==r?void 0:r.Item)||void 0===t?void 0:t.value)&&void 0!==o?o:null}catch(e){throw console.error(e),new n.InternalServerErrorException("Could not get an value")}}};l=r([(0,n.Injectable)()],l),t.OptionsService=l},501:function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),n=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(o(934),t)},475:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Roles=void 0;const r=o(481);t.Roles=(...e)=>(0,r.SetMetadata)("roles",e)},34:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.awsOptions=void 0,t.awsOptions={endpoint:"http://localhost:4566",region:"eu-central-1",accessKeyId:"local",secretAccessKey:"local"}},136:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.tryExecute=void 0;const r=o(481);t.tryExecute=async(e,t="")=>{try{return await e()}catch(e){throw console.error(e),new r.InternalServerErrorException(t)}}},481:e=>{e.exports=require("@nestjs/common")},143:e=>{e.exports=require("@nestjs/core")},64:e=>{e.exports=require("@nestjs/jwt")},188:e=>{e.exports=require("@nestjs/platform-express")},336:e=>{e.exports=require("aws-sdk")},315:e=>{e.exports=require("aws-serverless-express")},672:e=>{e.exports=require("aws-serverless-express/middleware")},167:e=>{e.exports=require("axios")},849:e=>{e.exports=require("class-validator")},860:e=>{e.exports=require("express")},806:e=>{e.exports=require("helmet")},608:e=>{e.exports=require("pug")},828:e=>{e.exports=require("uuid")},113:e=>{e.exports=require("crypto")},837:e=>{e.exports=require("util")}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};(()=>{o.r(r),o.d(r,{handler:()=>n});var e=o(315),t=o(179);const n=async(o,r)=>{const n=await(0,t.bootstrapServer)();return(0,e.proxy)(n,o,r,"PROMISE").promise}})();var n=exports;for(var i in r)n[i]=r[i];r.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();